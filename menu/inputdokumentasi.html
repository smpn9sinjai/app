<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Dokumentasi (Compress + Upload)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">

<style>
body{font-family:Inter;background:#f0f2f5;padding:20px}
.container{max-width:600px;margin:auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.1)}
label{display:block;margin-top:15px;font-weight:600}
input,button{width:100%;padding:10px;margin-top:5px;border-radius:6px;border:1px solid #ccc}
button{background:#2e86de;color:#fff;font-weight:bold;border:none;margin-top:25px}
.progress-bar{background:#ddd;height:18px;border-radius:5px;overflow:hidden;margin-top:6px}
.progress-fill{height:100%;width:0%;background:#2e86de;color:#fff;font-size:12px;text-align:center}
#hasil{margin-top:15px;font-weight:bold;text-align:center}
small{color:#666}
</style>
</head>

<body>
<div id="cpass">
<center>
<label>Maukksan password</label>
<input id="pass" type="password" style="width:200px" required><button onclick="go()" style="width:60px">OK</button><br>
<span id="hsl"></span>
</center>
</div>
<div id="kont" class="container" style="display:none">
<h2>ðŸ“¸ Input Dokumentasi</h2>

<form onsubmit="simpanSurat();return false;">
<label>Tanggal</label>
<input id="tgl" type="date" required>

<label>Nama Kegiatan</label>
<input id="hal" type="text" required>

<label>Dokumentasi (boleh 1â€“3 gambar)</label>
<input type="file" id="file1" accept="image/*">
<div class="progress-bar"><div id="prog1" class="progress-fill">0%</div></div>

<input type="file" id="file2" accept="image/*">
<div class="progress-bar"><div id="prog2" class="progress-fill">0%</div></div>

<input type="file" id="file3" accept="image/*">
<div class="progress-bar"><div id="prog3" class="progress-fill">0%</div></div>
<input type="file" id="file4" accept="image/*">
<div class="progress-bar"><div id="prog4" class="progress-fill">0%</div></div>
<input type="file" id="file5" accept="image/*">
<div class="progress-bar"><div id="prog5" class="progress-fill">0%</div></div>
<input type="file" id="file6" accept="image/*">
<div class="progress-bar"><div id="prog6" class="progress-fill">0%</div></div>
<input type="file" id="file7" accept="image/*">
<div class="progress-bar"><div id="prog7" class="progress-fill">0%</div></div>
<input type="file" id="file8" accept="image/*">
<div class="progress-bar"><div id="prog8" class="progress-fill">0%</div></div>
<input type="file" id="file9" accept="image/*">
<div class="progress-bar"><div id="prog9" class="progress-fill">0%</div></div>

<label>Max Width (px)</label>
<input id="maxWidth" type="number" value="1200">

<label>Quality (0.1 â€“ 1)</label>
<input id="quality" type="number" step="0.05" value="0.75">

<div id="hasil"></div>
<button>Simpan</button>
</form>
</div>
<script>
const google = {
  script: {
    run: {
      _success: function () {},
      _failure: function () {},

      withSuccessHandler(fn) {
        this._success = fn;
        return this;
      },

      withFailureHandler(fn) {
        this._failure = fn;
        return this;
      },

      token(pass,cari) {
        fetch("https://script.google.com/macros/s/AKfycbwjuXY-0KMjFE03QnMUFwkK3eCRQEA_VuQPkPtirKR2XHQs2vTiYER7yj5Ur6CErGcs/exec", {
          method: "POST",
          body: new URLSearchParams({
            pass: pass,
            cari: cari
          }) // â¬…ï¸ KUNCI
        })
        .then(res => res.text())          // â¬…ï¸ sesuai GAS Anda
        .then(text => this._success(text))
        .catch(err => this._failure(err));
      }
    }
  }
};
</script>
<script>
/* ================= CONFIG ================= */
let token = '655';  
    const username = 'smpn9sinjai';
    const repo = 'dokumentasi';
    const dataPath = 'data/surat.json';
    const branch = 'main';


function go(){
                google.script.run
                .withSuccessHandler(function(data){
				if(data=="salah"){document.getElementById("hsl").innerText="Password Salah";
				setTimeout(()=>{document.getElementById("hsl").innerText=''},2000)
				return}
				 
				document.getElementById("kont").style.display="block"
				document.getElementById("cpass").style.display="none"
				document.getElementById("pass").value='';
				token=data;
				return;
				})
                .withFailureHandler(function(data){
				document.getElementById("hsl").innerText="Error Jaringan";
				setTimeout(()=>{document.getElementById("hsl").innerText=''},2000)
				document.getElementById("kont").style.display="none"
				document.getElementById("cpass").style.display="block"
				
				})
                .token(document.getElementById("pass").value,'token');	
                 			
                }
/* ============= IMAGE COMPRESS ============= */
function compressImage(file, maxWidth, quality){
  return new Promise(resolve=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(maxWidth / img.width, 1);
        const canvas = document.createElement('canvas');
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>{
          resolve(blob);
        },'image/jpeg',quality);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

/* =============== UPLOAD =================== */
function uploadBlob(blob, filename, path, barId){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const xhr = new XMLHttpRequest();
      xhr.open("PUT",`https://api.github.com/repos/${username}/${repo}/contents/${path}`);
      xhr.setRequestHeader("Authorization","token "+token);
      xhr.setRequestHeader("Content-Type","application/json");

      xhr.upload.onprogress = e=>{
        if(e.lengthComputable){
          let p = Math.round(e.loaded/e.total*100);
          let bar = document.getElementById(barId);
          bar.style.width = p+"%";
          bar.innerText = p+"%";
        }
      };

      xhr.onload = ()=>{
        if(xhr.status==200 || xhr.status==201){
          resolve(JSON.parse(xhr.responseText).content.path);
        } else reject("Upload gagal");
      };

      xhr.send(JSON.stringify({
        message:"upload "+filename,
        content:btoa(reader.result),
        branch
      }));
    };
    reader.readAsBinaryString(blob);
  });
}

/* ============== MAIN SAVE ================= */
async function simpanSurat(){
  hasil.innerText="â³ Mengompres & upload...";
  let lampiran=[];

  const files=[
    {f:file1.files[0],bar:'prog1'},
    {f:file2.files[0],bar:'prog2'},
    {f:file3.files[0],bar:'prog3'},
	{f:file4.files[0],bar:'prog4'},
	{f:file5.files[0],bar:'prog5'},
	{f:file6.files[0],bar:'prog6'},
	{f:file7.files[0],bar:'prog7'},
	{f:file8.files[0],bar:'prog8'},
	{f:file9.files[0],bar:'prog9'},
 
	
  ];

  for(let i of files){
    if(i.f){
      const blob = await compressImage(
        i.f,
        parseInt(maxWidth.value),
        parseFloat(quality.value)
      );

      const name = Date.now()+"_"+i.f.name.replace(/\.(png|jpg|jpeg)/i,'.jpg');
      const path = 'lampiran/'+name;
      const res = await uploadBlob(blob,name,path,i.bar);
      lampiran.push(res);
    }
  }

  const dataBaru={
    tanggal:tgl.value,
    kegiatan:hal.value,
    lampiran
  };

  let lama=[], sha=null;
  let r = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${dataPath}`,{
    headers:{Authorization:"token "+token}
  });

  if(r.status==200){
    let j = await r.json();
    sha=j.sha;
    lama=JSON.parse(atob(j.content||"[]"));
  }

  lama.push(dataBaru);

  await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${dataPath}`,{
    method:"PUT",
    headers:{
      Authorization:"token "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:"Tambah dokumentasi",
      content:btoa(unescape(encodeURIComponent(JSON.stringify(lama,null,2)))),
      branch,
      ...(sha && {sha})
    })
  });

  hasil.innerText="âœ… Dokumentasi tersimpan";
  document.querySelector("form").reset();
  ["prog1","prog2","prog3","prog4","prog5","prog6","prog7","prog8","prog9"].forEach(id=>{
    let b=document.getElementById(id);
    b.style.width="0%";b.innerText="0%";
  });
}
</script>
</body>
</html>
